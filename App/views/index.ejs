<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>
    <%=title%>
  </title>

  <!-- Bootstrap Core CSS -->
  <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link href="/index/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet"
    type="text/css">
  <link href="/index/vendor/simple-line-icons/css/simple-line-icons.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="/index/css/stylish-portfolio.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/style.css">

  <link rel="shortcut icon" href="/images/favicon.ico" />

</head>

<body id="page-top">

  <!-- Loader -->

  <div id="loader">
    <img src="/images/loader.svg" alt="">
  </div>

  <div class="animate-bottom" id="content-page">

    <div id="linkAdmin">
      <a hidden id="linkManager" href="/manager"><img src="./images/manager.png" alt=""></a>
      <a hidden id="linkProvider" href="/provider"><img src="./images/provider.png" alt=""></a>
      <a hidden id="linkRegister" href="/provider"><img src="./images/register.png" alt=""></a>
    </div>

    <!-- Header -->
    <header class="masthead d-flex">
      <div class="container text-center my-auto">
        <h1 class="mb-1 text-white">Seek an origin</h1>
        <div class="container">
          <div class="row">
            <div class="col-md-10 col-lg-8 col-xl-7 mx-auto">
              <div id="boxSearch" class="box-search">
                <div class="text-search">
                  <div class="input-group ">
                    <input type="number" id="textSearch" class="form-control" placeholder="Search Code">
                  </div>
                </div>
                <div>
                  <button class="btn btn-primary" onclick="search()">Search</button>
                </div>
                <a id="toResult" class="js-scroll-trigger" href="#result"></a>
              </div>
            </div>
          </div>
        </div>
        <div class="overlay"></div>
      </div>
    </header>

    <!-- Result -->
    <section hidden class="content-section bg-light" id="result">
      <div class="container text-center">
        <div class="row">
          <div class="col-lg-10 mx-auto">
            <h1 hidden id="noResult">No Result</h1>
            <section id="contentResult">
              <div class="container">
                <div class="row align-items-center">
                  <div class="col-lg-6">
                    <div id="resultImage" class="p-5">
                      <img class="img-fluid" src="img/02.jpg" alt="resultImage">
                    </div>
                  </div>
                  <div class="col-lg-6">
                    <div class="p-5">
                      <h4 class="display-5" style="text-align: left; display: flex; justify-content: space-between" id="resultName">resultName</h4>
                      <div id="detailResult" style="text-align: left">
                      </div>
                      <div id="options" style="text-align: left">
                        <div class="container">
                          <ul class="list-inline mb-5">
                            <li class="list-inline-item" id="btnReport" hidden>
                              <a class="social-link rounded-circle text-white mr-3" href="javascript:void(0)">
                                <img src="/images/report.png" alt="">
                              </a>
                            </li>
                            <li class="list-inline-item" id="btnLock" hidden>
                              <a class="social-link rounded-circle text-white mr-3" href="javascript:void(0)">
                                <img src="/images/lock.png" alt="">
                              </a>
                            </li>
                            <li class="list-inline-item" id="btnUnlock" hidden>
                              <a class="social-link rounded-circle text-white" href="javascript:void(0)">
                                <img src="/images/unlock.png" alt="">
                              </a>
                            </li>
                          </ul>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </section>
          </div>
        </div>
      </div>
    </section>

    <!-- Modal register MEDICINE -->
    <div class="modal fade" id="modalReport" tabindex="-1" role="dialog" aria-labelledby="modalReportTitle" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalReportTitle">Form Report</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="formRegisterMedicine" action="#">
              <div class="form-row">
                <div class="form-group col-7">
                  <input type="text" class="form-control" disabled id="nameReport" placeholder="Name">
                </div>
                <div class="form-group col-5">
                  <input type="number" class="form-control" disabled id="idReport" placeholder="ID">
                </div>
              </div>
              <div class="form-group">
                <input type="text" class="form-control" disabled id="addressProvider" placeholder="Provider Address">
              </div>
              <div class="form-group">
                <input type="mail" class="form-control" id="emailReport" placeholder="Email">
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="streetReport" placeholder="Street">
              </div>
              <div class="form-group">
                <input type="text" class="form-control" id="phoneReport" placeholder="Phone">
              </div>
              <div class="form-group">
                <textarea type="text" class="form-control" rows="5" id="contentReport" placeholder="Content"></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="postReport()">Report</button>
          </div>
        </div>
      </div>
    </div>


    <div class="show-status hidden box-msg">
      <div class="box-close">
        <i class="fa fa-times-circle btn-close"></i>
      </div>
      <h5>title</h5>
      <p><a href="https://ropsten.etherscan.io/tx/" target="_blank"></a></p>
    </div>

    <div class="show-error hidden box-msg">
      <div class="box-close">
        <i class="fa fa-times-circle btn-close"></i>
      </div>
      <h5>title</h5>
      <p>content</p>
    </div>

    <!-- Footer -->
    <footer class="footer text-center">

      <div class="container">
        <ul class="list-inline mb-5">
          <li class="list-inline-item">
            <a class="social-link rounded-circle text-white mr-3" href="#">
              <i class="icon-social-facebook"></i>
            </a>
          </li>
          <li class="list-inline-item">
            <a class="social-link rounded-circle text-white mr-3" href="#">
              <i class="icon-social-twitter"></i>
            </a>
          </li>
          <li class="list-inline-item">
            <a class="social-link rounded-circle text-white" href="#">
              <i class="icon-social-github"></i>
            </a>
          </li>
        </ul>
        <p class="text-muted small mb-0">Copyright &copy; Your Website 2018</p>
      </div>
    </footer>

    <!-- Scroll to Top Button-->
    <a id="toTopPage" class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
      <i class="fas fa-angle-up"></i>
    </a>

  </div>

  <!-- Modal digital -->
  <%- include('./layout/viewDigitalCertificate'); -%>

  <script src="/jquery/jquery.min.js"></script>
  <script src="/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="/index/vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="/index/js/stylish-portfolio.min.js"></script>


  <script src="/jsfrontend/web3.min.js"></script>
  <script src="/jsfrontend/config.js"></script>
  <script src="/jsfrontend/medicine.js"></script>
  <script src="/js/app.js"></script>

  <script>
    function showPage() {
      document.getElementById("loader").style.display = "none";
      document.getElementById("content-page").style.opacity = "1";
    }

    function showLoad() {
      document.getElementById("loader").style.display = "block";
      document.getElementById("content-page").style.opacity = "0.3";
    }

    $('#textSearch').keypress(function (event) {
      var keycode = (event.keyCode ? event.keyCode : event.which);
      if (keycode == '13') {
        search();
      }
    });

    function checkShowLink() {
      checkIsProvider().then((res) => {
        if (!res[0].startsWith("0x0000")){
          document.getElementById('linkProvider').hidden = false;
          document.getElementById('linkRegister').hidden = true;
        }
        else{
          document.getElementById('linkProvider').hidden = true;
          document.getElementById('linkRegister').hidden = false;
        }
      })
      checkIsManager().then((res) => {
        if (res == true)
          document.getElementById('linkManager').hidden = false;
        else
          document.getElementById('linkManager').hidden = true;
      })
    }

    async function search() {
      account = await getAccount()
      document.getElementById('result').hidden = true;
      showLoad();
      $.get("/api/medicineByCode", {
        code: $('#textSearch').val()
      }, function (res) {
        if (res.status == 200) {
          $('#resultImage').html('<img style="width:100%; width: 100%;"  class="img-fluid" src="https://ipfs.io/ipfs/' + res.medicine[0][7] +
            '" alt="">');
          $('#resultName').html('<b>' + res.medicine[0][1] + '</b>');
          $('#detailResult').html(
            `<p><b>Ingredient:</b> ${res.medicine[0][2]}</p>
                        <p><b>Benefit:</b>  ${res.medicine[0][3]}</p>
                        <p><b>By:</b>  ${res.medicine[0][4]}</p>
                        <p><b>Detail:</b>  ${res.medicine[0][5]}</p>
                        <p><b>Prices:</b>  ${res.medicine[0][6]}</p>
                        <p><b>Status:</b>  ${res.medicine[0][9]} <small>${res.medicine[0][9] == true ? '<a href="javascript:void(0)" onclick="getViewDigitalCertificate(' + $('#textSearch').val() + ')">View Digital</a>' : ''}</small></p>
                        <p><b>Provider:</b>  ${res.provider[2]} (${res.provider[1]})</p>`
          );
          checkIsAccount().then(isAccount => {
            if (isAccount == true && res.medicine[0][9] == true) {
              $('#btnReport').html(`<a onclick="getReport('${$('#textSearch').val()}','${res.medicine[0][1]}','${res.provider[0]}')" class="social-link rounded-circle text-white mr-3" href="javascript:void(0)">
                                      <img src="/images/report.png" alt="">
                                    </a>`)
              document.getElementById('btnReport').hidden = false
            }
            else {
              document.getElementById('btnReport').hidden = true
            }
          })

          checkIsManager().then(isManager => {
            if (isManager == true) {
              $.get("/api/getDigitalCertifiCateByMedicineId", {
                medicineId: res.medicine[0][0],
                providerAddress: res.medicine[1]
              }, function (infoDigital) {
                console.log(infoDigital)
                if (infoDigital.data[6] == true && infoDigital.data[0] != 0) {
                  $('#btnLock').html(`<a onclick="blockMedicine('${$('#textSearch').val()}')" class="social-link rounded-circle text-white mr-3" href="javascript:void(0)">
                                      <img src="/images/lock.png" alt="">
                                    </a>`)
                  document.getElementById('btnLock').hidden = false
                  document.getElementById('btnUnlock').hidden = true
                } else if (infoDigital.data[6] == false && infoDigital.data[0] != 0) {
                  $('#btnUnlock').html(`<a onclick="unlockMedicine('${$('#textSearch').val()}')" class="social-link rounded-circle text-white mr-3" href="javascript:void(0)">
                                      <img src="/images/unlock.png" alt="">
                                    </a>`)
                  document.getElementById('btnLock').hidden = true
                  document.getElementById('btnUnlock').hidden = false
                }
                else {
                  document.getElementById('btnLock').hidden = true
                  document.getElementById('btnUnlock').hidden = true
                }
              })
            }
          })
          document.getElementById('noResult').hidden = true;
          document.getElementById('contentResult').hidden = false;
        } else {
          $.get("/api/providerByCode", {
            code: $('#textSearch').val()
          }, function (res) {
            if (res.status == 200 && res.provider[1] != 0) {
              $('#resultImage').html('<img class="img-fluid" src="https://ipfs.io/ipfs/' + res.provider[5] +
                '" alt="">');
              $('#resultName').html('<b>' + res.provider[2] + '</b>');
              $('#detailResult').html(
                `<p><b>ID:</b> ${res.provider[1]}</p>
                        <p><b>Street:</b> ${res.provider[3]}</p>
                        <p><b>Phone: </b>${res.provider[4]}</p>`
              );
              document.getElementById('noResult').hidden = true;
              document.getElementById('contentResult').hidden = false;
            } else {
              document.getElementById('noResult').hidden = false;
              document.getElementById('contentResult').hidden = true;
            }
          });
        }
        document.getElementById('result').hidden = false;
        showPage();
        $('#toResult').click();
      });
    }

    function getReport(id, name, address) {
      checkReportMedicine($('#textSearch').val(), account).then(isReported => {
        if (isReported == false) {
          $('#nameReport').val(name);
          $('#idReport').val(id);
          $('#addressProvider').val(address);
          $('#modalReport').modal('show')
        }
        else {
          showError('Report', 'You have reported')
        }
      })
    }

    async function postReport() {
      reportMedicine($('#idReport').val(), $('#addressProvider').val(), $('#emailReport').val(), $('#streetReport').val(), $('#phoneReport').val(), $('#contentReport').val())
      $('#modalReport').modal('hide')
    }

    async function getViewDigitalCertificate(medicineCode) {
      account = await getAccount();
      $.get("/api/medicineByCode", {
        code: medicineCode
      }, function (res) {
        console.log('medicineByCode', res);
        medicine = res.medicine;
        provider = res.provider;
        $('#digitalImageMedicine').attr("src", "https://ipfs.io/ipfs/" + medicine[0][7]);
        $('#digitalIDMedicine').html(medicine[0][0]);
        $('#digitalNameMedicine').html('<b>Name:</b> ' + medicine[0][1]);
        $('#digitalIngredientMedicine').html('<b>Ingredient:</b> ' + medicine[0][2]);
        $('#digitalBenefitMedicine').html('<b>Benefit:</b> ' + medicine[0][3]);
        $('#digitalByMedicine').html('<b>By:</b> ' + medicine[0][4]);
        $('#digitalDetailMedicine').html('<b>Detail:</b> ' + medicine[0][5]);
        $('#digitalPricesMedicine').html('<b>Prices:</b> ' + medicine[0][6]);
        $('#digitalImageProvider').attr("src", "https://ipfs.io/ipfs/" + provider[5]);
        $('#digitalIDProvider').text(provider[1]);
        $('#digitalNameProvider').html('<b>Name:</b> ' + provider[2]);
        $('#digitalStreetProvider').html('<b>Street:</b> ' + provider[3]);
        $('#digitalPhoneProvider').html('<b>Phone:</b> ' + provider[4]);
        $.get("/api/getDigitalCertifiCateByMedicineId", {
          medicineId: medicine[0][0],
          providerAddress: account
        }, function (infoDigital) {
          console.log('getDigitalCertifiCateByMedicineId', infoDigital);
          time = new Date(parseInt(infoDigital.data[2]) * 1000).toLocaleString();
          $('#digitalIDTime').html('<b>DC-' + medicine[0][8] + ' - ' + time + '</b>');
        });
        $('#modalDigitalCertificate').modal('show');
      });
    }

    $(document).ready(function () {
      showLoad();

      setTimeout(() => {
        showPage()
      }, 500);

      checkShowLink();
      setInterval(() => {
        checkShowLink();
      }, 1000);

      $('#textSearch').click(function () {
        $('#toTopPage').click();
      });

    });
  </script>

</body>

</html>